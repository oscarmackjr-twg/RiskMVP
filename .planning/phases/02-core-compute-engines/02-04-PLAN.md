---
phase: 02-core-compute-engines
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - compute/pricers/abs_mbs.py
  - compute/pricers/registry.py
  - compute/cashflow/prepayment.py
  - compute/cashflow/default_model.py
  - compute/tests/golden/test_abs_mbs_golden.py
autonomous: true

must_haves:
  truths:
    - "ABS/MBS pricer generates cashflow schedule with prepayments"
    - "PSA prepayment model applies standard ramp (0.2% → 6% over 30 months)"
    - "CPR speeds configurable per scenario"
    - "Default and recovery modeling reduces expected cashflows"
  artifacts:
    - path: "compute/pricers/abs_mbs.py"
      provides: "ABS/MBS pricer with prepayment modeling"
      exports: ["price_abs_mbs"]
      min_lines: 100
    - path: "compute/cashflow/prepayment.py"
      provides: "PSA and CPR prepayment models"
      exports: ["apply_psa_prepayment", "apply_cpr_prepayment"]
      min_lines: 50
    - path: "compute/cashflow/default_model.py"
      provides: "Default and recovery modeling"
      exports: ["apply_default_model"]
      min_lines: 40
  key_links:
    - from: "compute/pricers/abs_mbs.py"
      to: "compute.cashflow.prepayment.apply_psa_prepayment"
      via: "cashflow projection"
      pattern: "apply_psa_prepayment"
    - from: "compute/cashflow/prepayment.py"
      to: "remaining_principal"
      via: "SMM calculation from CPR"
      pattern: "1\\.0 - \\(1\\.0 - cpr\\)"
---

<objective>
Implement ABS/MBS pricer (PRICE-04) with PSA/CPR prepayment modeling (CF-02) and default/recovery modeling (CF-03). Generates cashflow schedules with prepayments, defaults, and loss-adjusted present value.

Purpose: ABS/MBS are complex securitized products requiring cashflow projection with behavioral models. PSA 100% is industry baseline. Default modeling captures credit risk in collateral pool.

Output: ABS/MBS pricer with prepayment and default models, registered and tested.
</objective>

<execution_context>
@C:/Users/omack/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-compute-engines/02-RESEARCH.md
@compute/pricers/loan.py
@compute/quantlib/curve_builder.py
@compute/cashflow/prepayment.py
@compute/cashflow/default_model.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PSA and CPR prepayment models</name>
  <files>compute/cashflow/prepayment.py</files>
  <action>
Replace stub with PSA and CPR implementations:

**apply_psa_prepayment(schedule: List[Dict], psa_speed: float = 100.0) -> List[Dict]:**
- PSA model: CPR ramps from 0.2% to 6% over first 30 months, then constant
- Formula: base_cpr = min(month * 0.002, 0.06) for PSA 100%
- Actual CPR = base_cpr * (psa_speed / 100.0)
- Convert CPR to SMM (single monthly mortality): smm = 1.0 - (1.0 - cpr) ** (1.0 / 12.0)
- Apply to each period: prepay_amount = remaining_principal * smm
- Update remaining_principal -= prepay_amount
- Add 'prepayment' field to each cashflow dict
- Return modified schedule

**apply_cpr_prepayment(schedule: List[Dict], cpr: float) -> List[Dict]:**
- Constant CPR model (no ramp)
- Convert CPR to SMM
- Apply uniformly to all periods
- Return modified schedule

Follow research "Pattern 4: Prepayment Model Integration". Use existing stub structure. PSA formula from research section.

**Edge cases:** Zero remaining principal (no prepayment), negative rates (clamp to zero), month numbering starts at 1.
  </action>
  <verify>
Run: `python -c "from compute.cashflow.prepayment import apply_psa_prepayment; sch = [{'month': i, 'remaining_principal': 100.0 - i*2, 'principal': 2.0} for i in range(1, 30)]; result = apply_psa_prepayment(sch, 100.0); print(f'Month 10 prepay: {result[9][\"prepayment\"]:.4f}'); assert 'prepayment' in result[0]"`

Expected: Month 10 prepayment ~0.16 (2% CPR on ~$80 balance). No exceptions.
  </verify>
  <done>PSA and CPR prepayment models implemented. Ramp logic correct. SMM calculation validated. Cashflow schedules include prepayment field.</done>
</task>

<task type="auto">
  <name>Task 2: Implement default and recovery modeling</name>
  <files>compute/cashflow/default_model.py</files>
  <action>
Replace stub with default/recovery implementation:

**apply_default_model(schedule: List[Dict], pd_curve: List[float], lgd: float, ead_pct: float = 1.0) -> List[Dict]:**
- pd_curve: List of probability of default per period (cumulative or marginal)
- lgd: Loss given default (decimal, e.g., 0.40 = 40% loss)
- ead_pct: Exposure at default as % of remaining principal
- For each period:
  - default_amount = remaining_principal * ead_pct * pd_curve[period] * lgd
  - recovery = default_amount * (1.0 - lgd)
  - Reduce principal cashflow by default_amount
  - Add 'default_loss' and 'recovery' fields to cashflow dict
  - Update remaining_principal -= default_amount
- Return modified schedule

**Simplification:** Use marginal PD per period (not cumulative survival curves). Document in docstring that full credit model is Phase 4 enhancement.

Edge cases: PD > 1.0 (clamp), LGD > 1.0 (clamp), empty schedule (return empty).
  </action>
  <verify>
Run: `python -c "from compute.cashflow.default_model import apply_default_model; sch = [{'month': i, 'remaining_principal': 100.0, 'principal': 0} for i in range(1, 4)]; pd = [0.01, 0.01, 0.01]; result = apply_default_model(sch, pd, lgd=0.40); print(f'Total default loss: {sum(cf.get(\"default_loss\", 0) for cf in result):.2f}'); assert 'default_loss' in result[0]"`

Expected: Total default loss ~1.20 (3 periods × 1% PD × 40% LGD × 100 balance). No exceptions.
  </verify>
  <done>Default and recovery model implemented. PD and LGD applied to cashflows. Loss and recovery fields added to schedule.</done>
</task>

<task type="auto">
  <name>Task 3: Implement ABS/MBS pricer with cashflow projection</name>
  <files>compute/pricers/abs_mbs.py</files>
  <action>
Replace stub with full ABS/MBS pricer:

1. Import prepayment, default_model, curve_builder, cashflow.generator
2. Implement price_abs_mbs(position, instrument, market_snapshot, measures, scenario_id):
   - Apply scenario
   - Set evaluation date
   - Build discount curve (OIS or credit-adjusted)
   - Generate base amortization schedule from instrument terms (original balance, WAC, WAM)
   - Apply prepayment model:
     - Get psa_speed from instrument (default 100.0)
     - Call apply_psa_prepayment(schedule, psa_speed)
   - Apply default model:
     - Get PD curve from instrument or market_snapshot (rating-based)
     - Get LGD from instrument (default 0.40 for residential, 0.30 for commercial)
     - Call apply_default_model(schedule, pd_curve, lgd)
   - Discount cashflows:
     - For each period: pv += (principal + interest - default_loss + recovery) * discount_factor
   - Compute measures:
     - 'PV' → sum of discounted cashflows
     - 'WAL' (weighted average life) → sum(period * principal) / sum(principal)
     - 'DV01' → bump discount curve, reprice
   - Return results

**Simplification per research open question 2:** Use PSA model with fixed speed. Calibration to historical prepayments is future enhancement (flagged in STATE.md).

**Handle missing data:** If instrument lacks psa_speed, default to 100. If lacking PD curve, default to [0.01] * num_periods (1% per period).
  </action>
  <verify>
Run: `pytest compute/tests/golden/test_abs_mbs_golden.py::test_abs_mbs_basic -v` (test to be created in next task)

Expected: Test passes. PV calculated from cashflow schedule with prepayments and defaults.
  </verify>
  <done>ABS/MBS pricer implemented. Cashflow schedule generated with prepayments and defaults. PV and WAL measures computed.</done>
</task>

<task type="auto">
  <name>Task 4: Add golden tests and register pricer</name>
  <files>compute/tests/golden/test_abs_mbs_golden.py, compute/pricers/registry.py</files>
  <action>
**Create test_abs_mbs_golden.py:**

**test_abs_mbs_basic()**
- $1M pool, 5% WAC, 30-year WAM, PSA 100%, LGD 40%, PD 1% per year
- 4% discount curve
- Expected: PV < $1M (prepayments + defaults reduce value)
- Assert result['PV'] < 950000 and result['WAL'] < 15.0 (prepayments shorten WAL)

**test_abs_mbs_fast_prepayment()**
- Same pool, PSA 200% (fast prepayment)
- Assert WAL < 10.0 (faster prepayments → shorter life)
- Assert PV_200 > PV_100 (less interest income but lower duration risk)

**test_abs_mbs_default_sensitivity()**
- Same pool, vary LGD 20% vs 60%
- Assert PV_20LGD > PV_60LGD (lower losses → higher value)

Run tests. Commit: `test(02-04): add golden tests for ABS/MBS pricer`

**Update registry.py:**
```python
from compute.pricers.abs_mbs import price_abs_mbs
register("ABS_MBS", price_abs_mbs)
```

Run registry tests. Commit: `feat(02-04): implement ABS/MBS pricer with prepayment and default models`
  </action>
  <verify>
Run: `pytest compute/tests/golden/test_abs_mbs_golden.py -v`. Expected: 3 passes
Run: `python -c "from compute.pricers.registry import registered_types; print(len(registered_types()))"`. Expected: 7
  </verify>
  <done>3 ABS/MBS golden tests pass. Pricer registered. Worker can price ABS_MBS product types.</done>
</task>

</tasks>

<verification>
- [ ] PSA prepayment model ramps correctly (0.2% → 6% over 30 months)
- [ ] CPR model applies constant prepayment speed
- [ ] Default model reduces principal by PD × LGD × EAD
- [ ] ABS/MBS pricer generates full cashflow schedule
- [ ] 3 golden tests pass (basic, fast prepayment, default sensitivity)
- [ ] ABS_MBS registered in pricer registry
- [ ] WAL calculation correct (prepayments shorten life)
</verification>

<success_criteria>
- PSA and CPR prepayment models (CF-02) implemented per industry standard
- Default and recovery modeling (CF-03) reduces cashflows by expected losses
- price_abs_mbs() generates cashflow schedule with prepayments and defaults
- PV calculated from loss-adjusted discounted cashflows
- WAL (weighted average life) computed correctly
- 3 golden tests validate prepayment sensitivity, default sensitivity
- Pricer registered and functional in worker
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-compute-engines/02-04-SUMMARY.md`
</output>
