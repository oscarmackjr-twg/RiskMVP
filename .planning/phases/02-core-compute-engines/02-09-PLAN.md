---
phase: 02-core-compute-engines
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - compute/tests/golden/test_putable_bond_golden.py
  - compute/tests/golden/test_derivatives_golden.py
  - compute/tests/golden/test_structured_golden.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PUTABLE_BOND pricer has >=3 golden tests covering basic pricing, scenarios, and embedded option value"
    - "DERIVATIVES pricer has >=3 golden tests covering pay-fixed, receive-fixed, and DV01 sensitivity"
    - "STRUCTURED pricer has >=3 golden tests covering simple waterfall, shortfall, and multiple scenarios"
  artifacts:
    - path: "compute/tests/golden/test_putable_bond_golden.py"
      provides: "3 golden tests for putable bond pricer"
      contains: "test_putable_bond_basic, test_putable_bond_scenarios, test_putable_bond_credit_spread"
    - path: "compute/tests/golden/test_derivatives_golden.py"
      provides: "3 golden tests for derivatives pricer"
      contains: "test_swap_pay_fixed, test_swap_receive_fixed, test_swap_dv01_sensitivity"
    - path: "compute/tests/golden/test_structured_golden.py"
      provides: "3 golden tests for structured pricer"
      contains: "test_structured_simple_waterfall, test_structured_shortfall, test_structured_scenarios"
  key_links:
    - from: "compute/tests/golden/test_putable_bond_golden.py"
      to: "compute/pricers/putable_bond.py"
      via: "price_putable_bond function call"
      pattern: "price_putable_bond\\("
    - from: "compute/tests/golden/test_derivatives_golden.py"
      to: "compute/pricers/derivatives.py"
      via: "price_derivatives function call"
      pattern: "price_derivatives\\("
    - from: "compute/tests/golden/test_structured_golden.py"
      to: "compute/pricers/structured.py"
      via: "price_structured function call"
      pattern: "price_structured\\("
---

<objective>
Add missing golden tests to satisfy Phase 2 success criterion 8: "Each pricer has >=3 golden tests."

Purpose: Close verification gaps for three pricers (PUTABLE_BOND, DERIVATIVES, STRUCTURED) that currently have only 2 tests each. Add exactly 1 test per pricer to meet the >=3 requirement.

Output: Three test files updated with new golden tests, all tests passing.
</objective>

<execution_context>
@C:/Users/omack/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-compute-engines/02-VERIFICATION.md

# Existing test patterns
@compute/tests/golden/test_putable_bond_golden.py
@compute/tests/golden/test_derivatives_golden.py
@compute/tests/golden/test_structured_golden.py

# Reference tests for patterns
@compute/tests/golden/test_callable_bond_golden.py
@compute/tests/golden/test_floating_rate_golden.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credit spread test to putable bond golden tests</name>
  <files>compute/tests/golden/test_putable_bond_golden.py</files>
  <action>
Add test_putable_bond_credit_spread to test_putable_bond_golden.py.

Test should verify:
- Putable bond pricing with credit spread shock scenario
- Position: $1M notional putable bond (4% coupon, 5-year, putable at 100 after 3 years)
- Market snapshot: Base curve at 3.5%, scenario with +25bp credit spread shock
- Compute PV and CLEAN_PRICE in both BASE and SPREAD_25BP scenarios
- Assertions: Spread shock should decrease PV (credit spread widens → bond price falls), but put option provides downside protection (price should not fall below put price of 100)

Follow existing test patterns:
- Import QuantLib as ql, set evaluation date
- Position dict with position_id, quantity, attributes
- Instrument dict with product_type, issue_date, maturity_date, coupon_rate, frequency, day_count, put_schedule
- Market snapshot with calc_date, curves (instruments list), scenarios dict
- Call price_putable_bond with position, instrument, market_snapshot, measures, scenario_id
- Assert PV exists, is positive, and reasonable range
- Assert credit spread shock decreases PV
- Assert price change is bounded (put option provides floor)
  </action>
  <verify>pytest compute/tests/golden/test_putable_bond_golden.py -v</verify>
  <done>3 tests in test_putable_bond_golden.py, all passing</done>
</task>

<task type="auto">
  <name>Task 2: Add DV01 sensitivity test to derivatives golden tests</name>
  <files>compute/tests/golden/test_derivatives_golden.py</files>
  <action>
Add test_swap_dv01_sensitivity to test_derivatives_golden.py.

Test should verify:
- Swap DV01 calculation and rate sensitivity
- Position: $1M notional pay-fixed swap (5% fixed, 5-year maturity)
- Market snapshot: Flat 4% OIS and SOFR curves
- Compute DV01 in BASE scenario, then price in BASE and RATES_PARALLEL_1BP scenario
- Calculate DV01 from finite difference: (PV_down - PV_base) / 1bp
- Assertions: DV01 measure exists and is reasonable (typically -$400 to -$600 per bp for 5-year swap), finite difference DV01 should match pricer DV01 within 10%, verify DV01 is negative for pay-fixed swap (rates up → PV down)

Follow existing test patterns:
- Market snapshot with snapshot_date, curves list (USD-OIS with nodes, USD-SOFR with nodes)
- Position dict with position_id, attributes.notional
- Instrument dict with swap_type, fixed_rate, maturity_years
- Call price_derivatives with position, instrument, market_snapshot, measures, scenario_id
- Assert DV01 in result
- Price in both BASE and RATES_PARALLEL_1BP scenarios
- Calculate finite difference DV01 and compare to pricer output
- Assert DV01 sign is correct (negative for pay-fixed)
  </action>
  <verify>pytest compute/tests/golden/test_derivatives_golden.py -v</verify>
  <done>3 tests in test_derivatives_golden.py, all passing</done>
</task>

<task type="auto">
  <name>Task 3: Add multiple scenarios test to structured product golden tests</name>
  <files>compute/tests/golden/test_structured_golden.py</files>
  <action>
Add test_structured_scenarios to test_structured_golden.py.

Test should verify:
- Structured product pricing across multiple scenarios (BASE, RATES_UP, RATES_DOWN)
- Position: Senior tranche of 2-tranche CLO ($80M senior at 4%, $20M junior at 8%)
- Collateral cashflows: 3 periods with interest and principal
- Market snapshot: 3.5-4% base curve with parallel +100bp and -100bp scenarios
- Compute PV in BASE, RATES_UP, RATES_DOWN scenarios
- Assertions: All PVs positive, RATES_DOWN should increase PV (discount rates fall → PV rises), RATES_UP should decrease PV (discount rates rise → PV falls), verify reasonable price changes (within 10-15% for 100bp shock on 5-year average maturity)

Follow existing test patterns:
- Market snapshot with snapshot_date, curves list with nodes, scenarios dict
- Instrument with instrument_id, tranches list (tranche_id, priority, notional, coupon), collateral_cashflows list (period, interest, principal)
- Position dict with position_id, tranche_id, attributes.notional
- Call price_structured for senior tranche in each scenario
- Assert PV exists in all scenarios
- Assert rate scenario sensitivities are directionally correct
- Assert PV changes are reasonable magnitudes
  </action>
  <verify>pytest compute/tests/golden/test_structured_golden.py -v</verify>
  <done>3 tests in test_structured_golden.py, all passing</done>
</task>

</tasks>

<verification>
## Overall Verification

Run full golden test suite:
```bash
pytest compute/tests/golden/ -v
```

Verify all 26 golden tests pass (23 existing + 3 new):
- test_putable_bond_golden.py: 3 tests (was 2)
- test_derivatives_golden.py: 3 tests (was 2)
- test_structured_golden.py: 3 tests (was 2)

All Phase 2 pricers now have >=3 golden tests each.
</verification>

<success_criteria>
- test_putable_bond_golden.py has 3 tests, all passing
- test_derivatives_golden.py has 3 tests, all passing
- test_structured_golden.py has 3 tests, all passing
- New tests follow existing patterns (QuantLib setup, position/instrument dicts, market snapshots, assertions)
- New tests verify meaningful scenarios (credit spread shock, DV01 sensitivity, multiple rate scenarios)
- Phase 2 success criterion 8 fully satisfied: "Each pricer has >=3 golden tests"
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-compute-engines/02-09-SUMMARY.md`
</output>
