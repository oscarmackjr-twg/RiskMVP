---
phase: 02-core-compute-engines
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - compute/pricers/callable_bond.py
  - compute/pricers/putable_bond.py
  - compute/pricers/registry.py
  - compute/tests/golden/test_callable_bond_golden.py
  - compute/tests/golden/test_putable_bond_golden.py
autonomous: true

must_haves:
  truths:
    - "Callable bonds price with embedded call option using tree-based valuation"
    - "OAS calculation captures option-adjusted spread vs. market price"
    - "Putable bonds price with embedded put option"
    - "Hull-White model parameters calibrated or use market-standard defaults"
  artifacts:
    - path: "compute/pricers/callable_bond.py"
      provides: "Callable bond pricer with OAS"
      exports: ["price_callable_bond"]
      min_lines: 80
    - path: "compute/pricers/putable_bond.py"
      provides: "Putable bond pricer"
      exports: ["price_putable_bond"]
      min_lines: 60
    - path: "compute/tests/golden/test_callable_bond_golden.py"
      provides: "Golden tests with reference prices"
      min_lines: 50
  key_links:
    - from: "compute/pricers/callable_bond.py"
      to: "QuantLib.TreeCallableFixedRateBondEngine"
      via: "pricing engine"
      pattern: "TreeCallableFixedRateBondEngine"
    - from: "compute/pricers/callable_bond.py"
      to: "QuantLib.HullWhite"
      via: "short rate model"
      pattern: "HullWhite"
    - from: "compute/pricers/registry.py"
      to: "price_callable_bond"
      via: "register in _bootstrap"
      pattern: "register.*CALLABLE_BOND"
---

<objective>
Implement institutional-grade callable and putable bond pricers using QuantLib tree-based valuation with Hull-White model. Supports OAS, YTC, and embedded option pricing.

Purpose: PRICE-02 and PRICE-03 require callable/putable bond pricing with option-adjusted spreads. These are core fixed-income instruments for institutional portfolios. Tree-based valuation is the industry standard for bonds with embedded options.

Output: Two working pricers (callable, putable) registered in pricer registry with golden tests validating against reference prices.
</objective>

<execution_context>
@C:/Users/omack/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-compute-engines/02-RESEARCH.md
@compute/pricers/bond.py
@compute/pricers/registry.py
@compute/quantlib/curve_builder.py
@compute/quantlib/day_count.py
</context>

<feature>
  <name>Callable Bond Pricer</name>
  <files>compute/pricers/callable_bond.py, compute/tests/golden/test_callable_bond_golden.py</files>
  <behavior>
    Given: 5% coupon bond, 5-year maturity, callable at par after 2 years, 3.5% flat curve
    When: price_callable_bond() called with measures=['PV', 'OAS', 'YTC']
    Then: Returns PV (dirty price), OAS (option-adjusted spread), YTC (yield-to-call)

    Cases:
    - Callable bond with flat curve → PV < straight bond (call option value)
    - OAS calculation with market price → solves for spread that matches price
    - Multiple call dates → prices earliest optimal exercise
  </behavior>
  <implementation>
1. Create QuantLib CallableFixedRateBond from instrument definition (coupon, maturity, call_schedule)
2. Build call schedule from instrument['call_schedule'] (list of {date, price, type})
3. Construct Hull-White model with market-standard parameters (a=0.03, sigma=0.12 for USD)
4. Set TreeCallableFixedRateBondEngine with 40 grid points
5. Compute measures: NPV() for PV, OAS via Brent solver, YTC from call dates
6. Handle scenarios via curve relinking (ZeroSpreadedTermStructure for shocks)

Follow research "Pattern 1: QuantLib Pricer Wrapper Pattern" and "Code Example: Pricing a Callable Bond with OAS".

**Hull-White calibration:** Use fixed parameters (a=0.03, sigma=0.12) per research open question 1. Document in code comment that calibration to swaption vols is future enhancement.
  </implementation>
</feature>

<feature>
  <name>Putable Bond Pricer</name>
  <files>compute/pricers/putable_bond.py, compute/tests/golden/test_putable_bond_golden.py</files>
  <behavior>
    Given: 4% coupon bond, 5-year maturity, putable at par after 3 years, 3.5% flat curve
    When: price_putable_bond() called with measures=['PV', 'YTP']
    Then: Returns PV (dirty price), YTP (yield-to-put)

    Cases:
    - Putable bond with flat curve → PV > straight bond (put option value)
    - Multiple put dates → prices optimal exercise from investor perspective
  </behavior>
  <implementation>
Similar to callable bond but with Callability.Put instead of Callability.Call. Same TreeCallableFixedRateBondEngine and Hull-White model. Compute YTP (yield-to-put) from optimal exercise date.
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>RED: Write failing test for callable bond pricing</name>
  <files>compute/tests/golden/test_callable_bond_golden.py</files>
  <action>
Create test file with 3 test cases:

**test_callable_bond_basic()**
- 5% coupon, 5-year maturity, callable at 100 after 2 years
- 3.5% flat curve
- Expected PV: ~68.4 (from research code example)
- Assert abs(result['PV'] - 68.4) < 1.0

**test_callable_bond_oas()**
- Same bond, market price = 102
- Calculate OAS
- Assert OAS > 0 (spread above treasury)

**test_callable_bond_scenarios()**
- Price in BASE and RATES_PARALLEL_100BP scenarios
- Assert PV_down > PV_base (rates down = price up)

Run test (MUST fail - pricer not implemented yet). Commit: `test(02-02): add failing tests for callable bond`
  </action>
  <verify>Run: `pytest compute/tests/golden/test_callable_bond_golden.py -v`. Expected: 3 failures (NotImplementedError)</verify>
  <done>Test file created with 3 failing tests for callable bond pricer.</done>
</task>

<task type="auto">
  <name>GREEN: Implement callable bond pricer to pass tests</name>
  <files>compute/pricers/callable_bond.py</files>
  <action>
Replace stub with full implementation:

1. Import QuantLib as ql, curve_builder, day_count, scenarios
2. Implement price_callable_bond(position, instrument, market_snapshot, measures, scenario_id):
   - Apply scenario to market_snapshot
   - Set ql.Settings.instance().evaluationDate from position['attributes']['as_of_date']
   - Build discount curve using curve_builder.build_discount_curve()
   - Parse call_schedule from instrument (list of {call_date, call_price, call_type})
   - Create ql.CallabilitySchedule with Callability.Call entries
   - Build bond schedule using ql.MakeSchedule(issue_date, maturity_date, frequency)
   - Create CallableFixedRateBond with settlement_days=2, coupon, day count, call schedule
   - Create HullWhite model: ql.HullWhite(curve_handle, a=0.03, sigma=0.12)
   - Set TreeCallableFixedRateBondEngine with grid_points=40
   - Compute measures:
     - 'PV' → bond.NPV()
     - 'CLEAN_PRICE' → bond.cleanPrice()
     - 'OAS' → use Brent solver (if market_price in position)
     - 'YTC' → bond.bondYield() to earliest call date
   - Return Dict[str, float]

Handle edge cases: missing call_schedule (raise ValueError), evaluation date not set (set from position), curve not found (raise KeyError).

Run tests (MUST pass). Commit: `feat(02-02): implement callable bond pricer with OAS`
  </action>
  <verify>Run: `pytest compute/tests/golden/test_callable_bond_golden.py -v`. Expected: 3 passes</verify>
  <done>Callable bond pricer implemented. All tests pass. PV, OAS, YTC measures computed correctly.</done>
</task>

<task type="auto">
  <name>RED-GREEN: Implement putable bond pricer with TDD</name>
  <files>compute/pricers/putable_bond.py, compute/tests/golden/test_putable_bond_golden.py</files>
  <action>
Follow RED-GREEN cycle for putable bond:

**RED:** Create test_putable_bond_golden.py with 2 tests:
- test_putable_bond_basic(): 4% coupon, 5-year, putable at 100 after 3 years, expect PV > straight bond
- test_putable_bond_scenarios(): Price in BASE and RATES_PARALLEL_100BP

Run tests (MUST fail). Commit: `test(02-02): add failing tests for putable bond`

**GREEN:** Implement price_putable_bond() in putable_bond.py:
- Similar to callable bond but use Callability.Put instead of Callability.Call
- Put schedule from instrument['put_schedule']
- Same Hull-White + TreeCallableFixedRateBondEngine
- Compute YTP (yield-to-put) from optimal put exercise date

Run tests (MUST pass). Commit: `feat(02-02): implement putable bond pricer`
  </action>
  <verify>Run: `pytest compute/tests/golden/test_putable_bond_golden.py -v`. Expected: 2 passes</verify>
  <done>Putable bond pricer implemented with TDD. Tests pass. YTP computed correctly.</done>
</task>

<task type="auto">
  <name>Register new pricers in registry and update worker</name>
  <files>compute/pricers/registry.py</files>
  <action>
Update _bootstrap() function in registry.py:

Add imports:
```python
from compute.pricers.callable_bond import price_callable_bond
from compute.pricers.putable_bond import price_putable_bond
```

Add registrations:
```python
register("CALLABLE_BOND", price_callable_bond)
register("PUTABLE_BOND", price_putable_bond)
```

Verify registered_types() now returns 5 pricers (FX_FWD, AMORT_LOAN, FIXED_BOND, CALLABLE_BOND, PUTABLE_BOND).

Run existing registry tests to ensure no regression. Commit: `feat(02-02): register callable and putable bond pricers`
  </action>
  <verify>Run: `python -c "from compute.pricers.registry import registered_types; print(sorted(registered_types()))"`. Expected: ['AMORT_LOAN', 'CALLABLE_BOND', 'FIXED_BOND', 'FX_FWD', 'PUTABLE_BOND']</verify>
  <done>Callable and putable bond pricers registered. Worker can dispatch to them without code changes.</done>
</task>

</tasks>

<verification>
- [ ] 3 callable bond golden tests pass
- [ ] 2 putable bond golden tests pass
- [ ] Callable bond PV matches research reference (~68.4 for example bond)
- [ ] OAS calculation works (Brent solver converges)
- [ ] Hull-White parameters documented (a=0.03, sigma=0.12)
- [ ] Both pricers registered in registry
- [ ] Worker can claim task with product_type=CALLABLE_BOND and price successfully
</verification>

<success_criteria>
- price_callable_bond() prices callable bonds using TreeCallableFixedRateBondEngine with Hull-White model
- OAS calculation works via Brent solver matching market price
- price_putable_bond() prices putable bonds with embedded put options
- YTC and YTP computed from optimal exercise dates
- 5 golden tests pass (3 callable, 2 putable)
- Both pricers registered and functional in worker
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-compute-engines/02-02-SUMMARY.md`
</output>
