---
phase: 01-foundation-infrastructure
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions runs lint and test on every commit"
    - "Builds Docker images and pushes to ECR on main branch"
    - "Deploys to AWS ECS on successful build"
    - "Failures block merge to main"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow for lint, test, build"
      min_lines: 40
      contains: "on: [push, pull_request]"
    - path: ".github/workflows/deploy.yml"
      provides: "Deploy workflow for AWS ECS"
      min_lines: 30
      contains: "aws-actions/configure-aws-credentials"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "docker/Dockerfile.*"
      via: "docker build commands"
      pattern: "docker build.*-f docker/Dockerfile"
    - from: ".github/workflows/deploy.yml"
      to: "terraform/"
      via: "ECS task definition updates"
      pattern: "ecs update-service"
---

<objective>
Establish GitHub Actions CI/CD pipeline for automated testing, building, and deployment.

Purpose: Completes PLAT-05 (GitHub Actions CI/CD). Automates quality gates, Docker image builds, ECR push, and ECS deployment. Research confirms GitHub Actions is industry standard with native integration.

Output: Every commit triggers lint + test. Main branch builds + deploys to AWS. Failures block merge.
</objective>

<execution_context>
@C:/Users/omack/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Codebase context
@.planning/codebase/STACK.md
@.planning/codebase/TESTING.md

# Docker context (from 01-03)
@docker/Dockerfile.marketdata
@docker/Dockerfile.orchestrator
@docker/Dockerfile.results
@docker/Dockerfile.worker

# Terraform context (from 01-04)
# ECS task definitions are in terraform/ecs.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow for lint, test, and build</name>
  <files>
.github/workflows/ci.yml
  </files>
  <action>
Create GitHub Actions workflow for continuous integration.

**ci.yml:**

Trigger: Push to any branch, pull requests to main

Jobs:

**1. Lint (Python):**
- Checkout code
- Setup Python 3.11
- Install dependencies: `pip install ruff mypy`
- Run ruff: `ruff check .`
- Run mypy (optional): `mypy compute/ services/ --ignore-missing-imports`

Note: Research shows no linting configured in pyproject.toml. Add ruff as lightweight linter. Mypy is optional (may fail on MVP code without strict typing).

**2. Test:**
- Checkout code
- Setup Python 3.11
- Install dependencies from pyproject.toml: `pip install -e .`
- Install test dependencies: `pip install pytest`
- Run pytest: `pytest compute/tests/ -v`

**3. Build (Docker images):**
- Checkout code
- Setup Docker Buildx
- Build all 4 images:
  ```yaml
  - docker build -f docker/Dockerfile.marketdata -t iprs-marketdata:${{ github.sha }} .
  - docker build -f docker/Dockerfile.orchestrator -t iprs-orchestrator:${{ github.sha }} .
  - docker build -f docker/Dockerfile.results -t iprs-results:${{ github.sha }} .
  - docker build -f docker/Dockerfile.worker -t iprs-worker:${{ github.sha }} .
  ```
- Tag images with commit SHA (for traceability)
- Do NOT push to ECR in CI job (only on deploy)

Research confirms:
- Lint runs fast, catches common errors
- Tests validate golden pricer outputs
- Build validates Dockerfiles without deployment

All jobs must pass for PR merge approval.
  </action>
  <verify>
git add .github/workflows/ci.yml
git commit -m "ci: add GitHub Actions CI workflow"
git push
# Check GitHub Actions tab for workflow run
  </verify>
  <done>
CI workflow file exists. Workflow triggers on push. Lint, test, build jobs defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deploy workflow for AWS ECS</name>
  <files>
.github/workflows/deploy.yml
  </files>
  <action>
Create GitHub Actions workflow for deployment to AWS ECS.

**deploy.yml:**

Trigger: Push to main branch only (after CI passes)

Jobs:

**1. Build and Push to ECR:**
- Checkout code
- Configure AWS credentials (using aws-actions/configure-aws-credentials@v4)
  - Role ARN from GitHub secrets: `AWS_ROLE_ARN`
  - Region from secrets: `AWS_REGION`
- Login to ECR: `aws ecr get-login-password | docker login`
- Build and tag images:
  ```yaml
  - docker build -f docker/Dockerfile.marketdata -t $ECR_REGISTRY/iprs-marketdata:${{ github.sha }} .
  - docker push $ECR_REGISTRY/iprs-marketdata:${{ github.sha }}
  - docker tag $ECR_REGISTRY/iprs-marketdata:${{ github.sha }} $ECR_REGISTRY/iprs-marketdata:latest
  - docker push $ECR_REGISTRY/iprs-marketdata:latest
  ```
- Repeat for all 4 services + worker

**2. Deploy to ECS:**
- Download current task definitions:
  ```bash
  aws ecs describe-task-definition --task-definition iprs-marketdata --query taskDefinition > task-def.json
  ```
- Update image in task definition JSON (jq or sed)
- Register new task definition:
  ```bash
  aws ecs register-task-definition --cli-input-json file://task-def.json
  ```
- Update ECS service to use new task definition:
  ```bash
  aws ecs update-service --cluster iprs-cluster --service iprs-marketdata --task-definition iprs-marketdata:$NEW_REVISION --force-new-deployment
  ```
- Repeat for all 4 services + worker

**3. Wait for deployment:**
- Poll ECS service status: `aws ecs wait services-stable --cluster iprs-cluster --services iprs-marketdata`
- Fail workflow if deployment doesn't stabilize within 10 minutes

Research confirms:
- OIDC role for GitHub Actions (avoids long-lived credentials)
- Blue/green deployment via new task revision
- Force new deployment ensures containers restart with latest image

GitHub Secrets required:
- AWS_ROLE_ARN (IAM role with ECS/ECR permissions)
- AWS_REGION (e.g., us-east-1)
- ECR_REGISTRY (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com)

Document required secrets in workflow comments.
  </action>
  <verify>
git add .github/workflows/deploy.yml
git commit -m "ci: add GitHub Actions deploy workflow"
# Deployment will run on next push to main (after secrets configured)
  </verify>
  <done>
Deploy workflow file exists. Workflow triggers on main branch push. ECR push and ECS deployment jobs defined.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document required GitHub secrets and workflow usage</name>
  <files>
.github/workflows/README.md
  </files>
  <action>
Create README documenting CI/CD workflows and required configuration.

**README.md:**

**CI/CD Workflows**

This directory contains GitHub Actions workflows for continuous integration and deployment.

**Workflows:**

1. **ci.yml** - Runs on every push and pull request
   - Lints Python code with ruff
   - Runs pytest test suite (compute/tests/)
   - Builds Docker images for validation
   - Required checks for PR merge approval

2. **deploy.yml** - Runs on push to main branch
   - Builds and pushes Docker images to AWS ECR
   - Updates ECS task definitions with new image tags
   - Deploys to ECS Fargate cluster
   - Waits for deployment to stabilize

**Required GitHub Secrets:**

Configure in repository Settings > Secrets and variables > Actions:

- `AWS_ROLE_ARN` - IAM role ARN for OIDC authentication (e.g., arn:aws:iam::123456789:role/github-actions-role)
- `AWS_REGION` - AWS region (e.g., us-east-1)
- `ECR_REGISTRY` - ECR registry URL (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com)

**IAM Role Permissions:**

GitHub Actions role needs:
- ecr:GetAuthorizationToken, ecr:BatchCheckLayerAvailability, ecr:PutImage, ecr:InitiateLayerUpload, ecr:UploadLayerPart, ecr:CompleteLayerUpload
- ecs:DescribeTaskDefinition, ecs:RegisterTaskDefinition, ecs:UpdateService, ecs:DescribeServices

**Local Testing:**

Run CI checks locally before pushing:
```bash
# Lint
ruff check .

# Test
pytest compute/tests/ -v

# Build
docker build -f docker/Dockerfile.marketdata -t iprs-marketdata:local .
```

**Troubleshooting:**

- If CI fails: Check workflow logs in GitHub Actions tab
- If deploy fails: Check ECS service events in AWS Console
- If images don't update: Verify ECR_REGISTRY secret matches Terraform output

Research confirms: Documenting workflows reduces onboarding friction.
  </action>
  <verify>
cat .github/workflows/README.md | grep "Required GitHub Secrets"
  </verify>
  <done>
README exists in .github/workflows/. Documents required secrets, IAM permissions, and workflow usage.
  </done>
</task>

</tasks>

<verification>
Validate workflow syntax:
```bash
# GitHub CLI validates workflow files
gh workflow list
```

Trigger CI manually (if repo is connected):
```bash
git add .
git commit -m "ci: add CI/CD workflows"
git push origin main
```

Check GitHub Actions tab:
- CI workflow should run automatically
- Deploy workflow triggers after CI passes on main branch

Verify required secrets are documented:
```bash
cat .github/workflows/README.md
```

Check workflow files exist:
```bash
ls -la .github/workflows/
```

Expected files: ci.yml, deploy.yml, README.md
</verification>

<success_criteria>
1. CI workflow exists and triggers on push/PR (verified via GitHub Actions)
2. Deploy workflow exists and triggers on main branch (verified via GitHub Actions)
3. CI runs lint, test, and build jobs (verified via workflow definition)
4. Deploy pushes to ECR and updates ECS services (verified via workflow definition)
5. Required GitHub secrets documented (verified in README.md)
6. Workflow syntax is valid (verified via gh workflow list or GitHub UI)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-05-SUMMARY.md`
</output>
