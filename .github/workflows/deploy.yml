name: Deploy to AWS ECS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: image-tag
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push marketdata service
        run: |
          docker build -f docker/Dockerfile.marketdata \
            -t ${{ env.ECR_REGISTRY }}/iprs-marketdata:${{ steps.image-tag.outputs.tag }} \
            -t ${{ env.ECR_REGISTRY }}/iprs-marketdata:latest .
          docker push ${{ env.ECR_REGISTRY }}/iprs-marketdata:${{ steps.image-tag.outputs.tag }}
          docker push ${{ env.ECR_REGISTRY }}/iprs-marketdata:latest

      - name: Build and push orchestrator service
        run: |
          docker build -f docker/Dockerfile.orchestrator \
            -t ${{ env.ECR_REGISTRY }}/iprs-orchestrator:${{ steps.image-tag.outputs.tag }} \
            -t ${{ env.ECR_REGISTRY }}/iprs-orchestrator:latest .
          docker push ${{ env.ECR_REGISTRY }}/iprs-orchestrator:${{ steps.image-tag.outputs.tag }}
          docker push ${{ env.ECR_REGISTRY }}/iprs-orchestrator:latest

      - name: Build and push results service
        run: |
          docker build -f docker/Dockerfile.results \
            -t ${{ env.ECR_REGISTRY }}/iprs-results:${{ steps.image-tag.outputs.tag }} \
            -t ${{ env.ECR_REGISTRY }}/iprs-results:latest .
          docker push ${{ env.ECR_REGISTRY }}/iprs-results:${{ steps.image-tag.outputs.tag }}
          docker push ${{ env.ECR_REGISTRY }}/iprs-results:latest

      - name: Build and push worker
        run: |
          docker build -f docker/Dockerfile.worker \
            -t ${{ env.ECR_REGISTRY }}/iprs-worker:${{ steps.image-tag.outputs.tag }} \
            -t ${{ env.ECR_REGISTRY }}/iprs-worker:latest .
          docker push ${{ env.ECR_REGISTRY }}/iprs-worker:${{ steps.image-tag.outputs.tag }}
          docker push ${{ env.ECR_REGISTRY }}/iprs-worker:latest

  deploy-ecs:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        service:
          - name: marketdata
            cluster: iprs-cluster-prod
            task-family: iprs-marketdata-prod
          - name: orchestrator
            cluster: iprs-cluster-prod
            task-family: iprs-orchestrator-prod
          - name: results
            cluster: iprs-cluster-prod
            task-family: iprs-results-prod
          - name: worker
            cluster: iprs-cluster-prod
            task-family: iprs-worker-prod

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download current task definition
        id: task-def
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task-family }} \
            --query taskDefinition > task-def.json
          cat task-def.json

      - name: Update image in task definition
        id: update-task-def
        run: |
          # Extract task definition and update image
          IMAGE_URI="${{ env.ECR_REGISTRY }}/iprs-${{ matrix.service.name }}:${{ needs.build-and-push.outputs.image-tag }}"

          # Update container image in task definition
          jq --arg IMAGE "$IMAGE_URI" \
            '.containerDefinitions[0].image = $IMAGE |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            task-def.json > task-def-updated.json

          cat task-def-updated.json

      - name: Register new task definition
        id: register-task
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def-updated.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered task definition: $TASK_DEF_ARN"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ matrix.service.cluster }} \
            --service iprs-${{ matrix.service.name }}-prod \
            --task-definition ${{ steps.register-task.outputs.task-def-arn }} \
            --force-new-deployment

      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting for service to stabilize (timeout: 10 minutes)..."
          aws ecs wait services-stable \
            --cluster ${{ matrix.service.cluster }} \
            --services iprs-${{ matrix.service.name }}-prod \
            --cli-read-timeout 600 \
            --cli-connect-timeout 600

      - name: Verify deployment
        run: |
          aws ecs describe-services \
            --cluster ${{ matrix.service.cluster }} \
            --services iprs-${{ matrix.service.name }}-prod \
            --query 'services[0].deployments' \
            --output table
