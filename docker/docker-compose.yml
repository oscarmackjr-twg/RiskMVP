services:
  # PostgreSQL database with schema initialization
  db:
    image: postgres:15
    container_name: iprs-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: iprs
    ports:
      - "5432:5432"
    volumes:
      # Mount SQL schemas for database initialization (executed in alphabetical order)
      - ../sql/001_mvp_core.sql:/docker-entrypoint-initdb.d/001_mvp_core.sql:ro
      - ../sql/002_portfolio_data_services.sql:/docker-entrypoint-initdb.d/002_portfolio_data_services.sql:ro
      - ../sql/003_regulatory_analytics.sql:/docker-entrypoint-initdb.d/003_regulatory_analytics.sql:ro
      # Persist database data (optional for development)
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d iprs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - iprs-network

  # Market Data Service (Port 8001)
  marketdata:
    build:
      context: ..
      dockerfile: docker/Dockerfile.marketdata
    container_name: iprs-marketdata
    ports:
      - "8001:8001"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Run Orchestrator Service (Port 8002)
  orchestrator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.orchestrator
    container_name: iprs-orchestrator
    ports:
      - "8002:8002"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      POSITIONS_SNAPSHOT_PATH: /app/demo/inputs/positions.json
      RUN_TASK_HASH_MOD: "1"
      RUN_TASK_MAX_ATTEMPTS: "3"
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Results API Service (Port 8003)
  results:
    build:
      context: ..
      dockerfile: docker/Dockerfile.results
    container_name: iprs-results
    ports:
      - "8003:8003"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Distributed Task Worker
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: iprs-worker
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      WORKER_ID: worker-compose-1
      WORKER_LEASE_SECONDS: "60"
      WORKER_IDLE_SLEEP_SECONDS: "0.5"
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
      orchestrator:
        condition: service_started
    networks:
      - iprs-network
    restart: unless-stopped

  # Portfolio Service (Port 8005)
  portfolio:
    build:
      context: ..
      dockerfile: docker/Dockerfile.portfolio
    container_name: iprs-portfolio
    ports:
      - "8005:8005"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Risk Service (Port 8006)
  risk:
    build:
      context: ..
      dockerfile: docker/Dockerfile.risk
    container_name: iprs-risk
    ports:
      - "8006:8006"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Regulatory Service (Port 8007)
  regulatory:
    build:
      context: ..
      dockerfile: docker/Dockerfile.regulatory
    container_name: iprs-regulatory
    ports:
      - "8007:8007"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # Data Ingestion Service (Port 8008)
  ingestion:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ingestion
    container_name: iprs-ingestion
    ports:
      - "8008:8008"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/iprs
      PYTHONUNBUFFERED: "1"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - iprs-network
    restart: unless-stopped

  # React Frontend (Port 80) â€” nginx reverse proxy to all services
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: iprs-frontend
    ports:
      - "80:80"
    depends_on:
      - marketdata
      - orchestrator
      - results
      - portfolio
      - risk
      - regulatory
      - ingestion
    networks:
      - iprs-network
    restart: unless-stopped

# Named volume for PostgreSQL data persistence
volumes:
  postgres_data:
    driver: local

# Shared network for service-to-service communication
networks:
  iprs-network:
    driver: bridge
