# nginx-aws.conf — AWS ECS variant with Cloud Map DNS resolution
# Uses variable-based proxy_pass to force DNS re-resolution on IP changes
# Note: rewrite is required because variable-based proxy_pass does NOT
# strip the location prefix automatically (unlike literal proxy_pass).

resolver 10.0.0.2 valid=10s;

server {
    listen 80;
    server_name _;

    # Serve React static files
    root /usr/share/nginx/html;
    index index.html;

    # API reverse proxy routes — strip prefix and forward to backend services

    location /mkt/ {
        set $upstream_marketdata "http://marketdata.iprs.local:8001";
        rewrite ^/mkt/(.*) /$1 break;
        proxy_pass $upstream_marketdata;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /orch/ {
        set $upstream_orchestrator "http://orchestrator.iprs.local:8002";
        rewrite ^/orch/(.*) /$1 break;
        proxy_pass $upstream_orchestrator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /results/ {
        set $upstream_results "http://results.iprs.local:8003";
        rewrite ^/results/(.*) /$1 break;
        proxy_pass $upstream_results;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /portfolio/ {
        set $upstream_portfolio "http://portfolio.iprs.local:8005";
        rewrite ^/portfolio/(.*) /$1 break;
        proxy_pass $upstream_portfolio;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /risk/ {
        set $upstream_risk "http://risk.iprs.local:8006";
        rewrite ^/risk/(.*) /$1 break;
        proxy_pass $upstream_risk;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /regulatory/ {
        set $upstream_regulatory "http://regulatory.iprs.local:8007";
        rewrite ^/regulatory/(.*) /$1 break;
        proxy_pass $upstream_regulatory;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/regulatory/ {
        set $upstream_regulatory_api "http://regulatory.iprs.local:8007";
        proxy_pass $upstream_regulatory_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ingestion/ {
        set $upstream_ingestion "http://ingestion.iprs.local:8008";
        rewrite ^/ingestion/(.*) /$1 break;
        proxy_pass $upstream_ingestion;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SPA fallback — serve index.html for client-side routing
    location / {
        try_files $uri $uri/ /index.html;
    }
}
